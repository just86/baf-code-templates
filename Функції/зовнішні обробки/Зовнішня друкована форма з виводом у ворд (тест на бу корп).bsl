#Область ОсновныеНастройкиДляПодключенияПечать

Функция СведенияОВнешнейОбработке() Экспорт
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Представление", ЭтотОбъект.Метаданные().Представление());
	СтруктураПараметров.Вставить("Наименование",  ЭтотОбъект.Метаданные().Синоним);
	СтруктураПараметров.Вставить("Идентификатор", ЭтотОбъект.Метаданные().Имя);
	СтруктураПараметров.Вставить("Версия",        "1.0.0.0");
	
	ВерсияБСП = СтандартныеПодсистемыСервер.ВерсияБиблиотеки();
	Сведения  = ДополнительныеОтчетыИОбработки.СведенияОВнешнейОбработке(ВерсияБСП);
	
	Сведения.Вид     = ДополнительныеОтчетыИОбработкиКлиентСервер.ВидОбработкиПечатнаяФорма();
	Сведения.Версия  = СтруктураПараметров.Версия;
	Сведения.Наименование = СтруктураПараметров.Наименование;
	
	Сведения.Назначение.Добавить("Документ.Отпуск");
	
	Команда = Сведения.Команды.Добавить();
	Команда.Представление = СтруктураПараметров.Представление;
	Команда.Идентификатор = СтруктураПараметров.Идентификатор;
	Команда.Использование = ДополнительныеОтчетыИОбработкиКлиентСервер.ТипКомандыВызовСерверногоМетода();   
	
	 Разрешение = РаботаВБезопасномРежиме.РазрешениеНаИспользованиеКаталогаВременныхФайлов(Истина, Истина); 
	 Сведения.Разрешения.Добавить(Разрешение);

	Возврат Сведения;
	
КонецФункции

#КонецОбласти

#Область Печать

Процедура Печать(МассивОбъектов, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
	// ДЛЯ ОТЛАДКИ
	//Адрес = "C:\Temp\налагодження\Відрядження.epf";
	//Если Адрес <> ЭтотОбъект.ИспользуемоеИмяФайла Тогда
	//  Обработка = ВнешниеОбработки.Создать(Адрес, БезопасныйРежим());
	//  ЗаполнитьЗначенияСвойств(Обработка, ЭтотОбъект);
	//  Обработка.Печать(МассивОбъектов, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода);
	//  Возврат;        
	//КонецЕсли;
	
	ИмяМакета = "МакетWORD"; // Должно совпадать с именем макета в метаданных
	ИмяВПФ    = "ДрукованаФормаВідпустка"; // Идентификатор команды
	
	ПечатнаяФорма = УправлениеПечатью.СведенияОПечатнойФорме(КоллекцияПечатныхФорм, ИмяВПФ);
	
	Если ПечатнаяФорма <> Неопределено Тогда
		
		ДанныеМакетов = МакетыОбъектаДляПечати(ИмяМакета);
		
		ОфисныеДокументы = Новый Соответствие;
		
		Для Каждого Ссылка Из МассивОбъектов Цикл
			
			// Формируем имя файла
			ИмяДокумента = Строка(Ссылка);
			
			АдресХранилищаОфисныйДокумент = НапечататьДокументOfficeOpenXML(Ссылка, ДанныеМакетов, ИмяМакета);
			
			Если ЗначениеЗаполнено(АдресХранилищаОфисныйДокумент) Тогда
				ОфисныеДокументы.Вставить(АдресХранилищаОфисныйДокумент, ИмяДокумента);
			КонецЕсли;
			
		КонецЦикла;
		
		ПечатнаяФорма.СинонимМакета    = "Друкована форма";
		ПечатнаяФорма.ОфисныеДокументы = ОфисныеДокументы;
		
	КонецЕсли;
	
КонецПроцедуры

Функция НапечататьДокументOfficeOpenXML(Ссылка, ДанныеМакетов, ИмяМакета)
	
	// 1. Получаем данные запросом
	ДанныеОбъекта = ПолучитьДанныеДляПечати(Ссылка);
	
	Если ДанныеОбъекта = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	// 2. Инициализация макета
	ТипМакета = ДанныеМакетов.ТипыМакетов[ИмяМакета];
	ДвоичныеДанныеМакета = ДанныеМакетов.ДвоичныеДанныеМакетов;
	Области = ДанныеМакетов.ОписаниеОбластей;
	
	Макет = УправлениеПечатью.ИнициализироватьМакетОфисногоДокумента(ДвоичныеДанныеМакета[ИмяМакета], ТипМакета, ИмяМакета);
	
	Если Макет = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	АдресХранилищаПечатнойФормы = "";
	ЗакрытьОкноПечатнойФормы = Ложь;
	
	Попытка
		
		ПечатнаяФорма = УправлениеПечатью.ИнициализироватьПечатнуюФорму(ТипМакета, Макет.НастройкиСтраницыМакета, Макет);
		
		Если ПечатнаяФорма = Неопределено Тогда
			УправлениеПечатью.ОчиститьСсылки(Макет);
			Возврат "";
		КонецЕсли;
		
		// 3. Вывод области "Шапка"
		Если Области[ИмяМакета].Свойство("Шапка") Тогда
			Область = УправлениеПечатью.ОбластьМакета(Макет, Области[ИмяМакета]["Шапка"]);
			УправлениеПечатью.ПрисоединитьОбластьИЗаполнитьПараметры(ПечатнаяФорма, Область, ДанныеОбъекта);
		КонецЕсли;
		
		// Пример вывода табличной части (закомментировано в оригинале)
		//Если ДанныеОбъекта.Свойство("Товары") И Области[ИмяМакета].Свойство("СтрокаТаблицаТовары") Тогда
		//	ОбластьШапкаТаблицы = УправлениеПечатью.ОбластьМакета(Макет, Области[ИмяМакета]["Товары"]);
		//	УправлениеПечатью.ПрисоединитьОбласть(ПечатнаяФорма, ОбластьШапкаТаблицы, Ложь);
		//	
		//	ОбластьСтроки = УправлениеПечатью.ОбластьМакета(Макет, Области[ИмяМакета]["СтрокаТаблицаТовары"]);
		//	УправлениеПечатью.ПрисоединитьИЗаполнитьКоллекцию(ПечатнаяФорма, ОбластьСтроки, ДанныеОбъекта.Товары);
		//КонецЕсли;
		
		АдресХранилищаПечатнойФормы = УправлениеПечатью.СформироватьДокумент(ПечатнаяФорма);
		
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЗакрытьОкноПечатнойФормы = Истина;
		АдресХранилищаПечатнойФормы = "";
	КонецПопытки;
	
	УправлениеПечатью.ОчиститьСсылки(ПечатнаяФорма, ЗакрытьОкноПечатнойФормы);
	УправлениеПечатью.ОчиститьСсылки(Макет);
	
	Возврат АдресХранилищаПечатнойФормы;
	
КонецФункции

Функция ПолучитьДанныеДляПечати(Ссылка)
	
	// Получаем ответственных лиц (стандартный механизм)
	СтруктураОтветственных = ОтветственныеЛицаБППереопределяемый.ОтветственныеЛица(Ссылка.Организация, Ссылка.Дата);
	РуководительСтрокой = СтруктураОтветственных.Руководитель; // ФИО руководителя
	Посада              = СтруктураОтветственных.РуководительДолжность;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ФИОФизическихЛицСрезПоследних.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ФИОФизическихЛицСрезПоследних.Фамилия КАК Фамилия,
	|	ФИОФизическихЛицСрезПоследних.Имя КАК Имя,
	|	ФИОФизическихЛицСрезПоследних.Отчество КАК Отчество
	|ПОМЕСТИТЬ ВТ_ФИО_ФИЗЛИЦ
	|ИЗ
	|	РегистрСведений.ФИОФизическихЛиц.СрезПоследних(&ДатаДокумента, ) КАК ФИОФизическихЛицСрезПоследних
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КадроваяИсторияСотрудниковСрезПоследних.Сотрудник КАК Сотрудник,
	|	КадроваяИсторияСотрудниковСрезПоследних.Подразделение КАК Подразделение,
	|	КадроваяИсторияСотрудниковСрезПоследних.Должность КАК Должность
	|ПОМЕСТИТЬ ВТ_Должность
	|ИЗ
	|	РегистрСведений.КадроваяИсторияСотрудников.СрезПоследних(&ДатаДокумента, ) КАК КадроваяИсторияСотрудниковСрезПоследних
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Отпуск.Дата КАК ДатаДокумента,
	|	Отпуск.Номер КАК НомерПриказа,
	|	Отпуск.Сотрудник КАК Сотрудник,
	|	ВТ_ФИО_ФИЗЛИЦ.Фамилия КАК Фамилия,
	|	ВТ_ФИО_ФИЗЛИЦ.Имя КАК Имя,
	|	ВТ_ФИО_ФИЗЛИЦ.Отчество КАК Отчество,
	|	ВТ_Должность.Подразделение КАК Подразделение,
	|	ВТ_Должность.Должность КАК Должность,
	|	Отпуск.ДатаНачалаОсновногоОтпуска КАК ДатаНачалаОсновногоОтпуска,
	|	Отпуск.ДатаОкончанияОсновногоОтпуска КАК ДатаОкончанияОсновногоОтпуска,
	|	Отпуск.КоличествоДнейОсновногоОтпуска КАК КоличествоДнейОсновногоОтпуска,
	|	Отпуск.НачалоПериодаЗаКоторыйПредоставляетсяОтпуск КАК НачалоПериодаЗаКоторыйПредоставляетсяОтпуск,
	|	Отпуск.КонецПериодаЗаКоторыйПредоставляетсяОтпуск КАК КонецПериодаЗаКоторыйПредоставляетсяОтпуск,
	|	Отпуск.Организация.НаименованиеПолное КАК ОрганизацияНаименованиеПолное,
	|	Отпуск.Организация.Наименование КАК ОрганизацияНаименование,
	|	Отпуск.Организация.КодПоЕДРПОУ КАК ОрганизацияКодПоЕДРПОУ,
	|	СклоненияПредставленийОбъектов.ДательныйПадеж КАК ДательныйПадеж,
	|	СклоненияПредставленийОбъектов.РодительныйПадеж КАК РодительныйПадеж,
	|	СклоненияПредставленийОбъектов1.ДательныйПадеж КАК ДолжностьДательныйПадеж,
	|	СклоненияПредставленийОбъектов2.ДательныйПадеж КАК ПодразделениеДательныйПадеж,
	|	ВТ_Должность.Подразделение.МістоДляДруку КАК МістоДляДруку
	|ИЗ
	|	Документ.Отпуск КАК Отпуск
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ФИО_ФИЗЛИЦ КАК ВТ_ФИО_ФИЗЛИЦ
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СклоненияПредставленийОбъектов КАК СклоненияПредставленийОбъектов
	|			ПО ВТ_ФИО_ФИЗЛИЦ.ФизическоеЛицо = СклоненияПредставленийОбъектов.Объект
	|		ПО Отпуск.Сотрудник.ФизическоеЛицо = ВТ_ФИО_ФИЗЛИЦ.ФизическоеЛицо
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Должность КАК ВТ_Должность
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СклоненияПредставленийОбъектов КАК СклоненияПредставленийОбъектов1
	|			ПО ВТ_Должность.Должность = СклоненияПредставленийОбъектов1.Объект
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СклоненияПредставленийОбъектов КАК СклоненияПредставленийОбъектов2
	|			ПО ВТ_Должность.Подразделение = СклоненияПредставленийОбъектов2.Объект
	|		ПО Отпуск.Сотрудник = ВТ_Должность.Сотрудник
	|ГДЕ
	|	Отпуск.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ДатаДокумента", Ссылка.Дата);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий(); // Позиционируемся на первой записи
	
	// Подготовка структуры данных для макета
	ДанныеОбъекта = Новый Структура;
	ДанныеОбъекта.Вставить("ДатаДокумента",             Формат(Выборка.ДатаДокумента, "ДФ=dd.MM.yyyy"));
	ДанныеОбъекта.Вставить("НомерПриказа",              Выборка.НомерПриказа);
	
	// Формирование подразделения и должности (первая буква строчная, как в оригинале)
	ДанныеОбъекта.Вставить("Подразделение", СтрШаблон("%1%2", НРег(Лев(Выборка.ПодразделениеДательныйПадеж,1)), Сред(Выборка.ПодразделениеДательныйПадеж, 2)));
	ДанныеОбъекта.Вставить("Должность",     СтрШаблон("%1%2", НРег(Лев(Выборка.ДолжностьДательныйПадеж,1)),     Сред(Выборка.ДолжностьДательныйПадеж, 2)));
	
	ДанныеОбъекта.Вставить("City", ?(ЗначениеЗаполнено(Выборка.МістоДляДруку), Выборка.МістоДляДруку, "Київ"));
	
	ДанныеОбъекта.Вставить("ПолноеНаименованиеОрганизация", Выборка.ОрганизацияНаименованиеПолное);
	ДанныеОбъекта.Вставить("НаименованиеОрганизация",       Выборка.ОрганизацияНаименование);
	ДанныеОбъекта.Вставить("EDRPOU",                        Выборка.ОрганизацияКодПоЕДРПОУ);
	
	// --- Обработка Руководителя ---
	МногострочнаяСтрока = СтрЗаменить(РуководительСтрокой, " ", Символы.ПС);
	ФамилияРук = СтрПолучитьСтроку(МногострочнаяСтрока, 1);
	ИмяРук     = СтрПолучитьСтроку(МногострочнаяСтрока, 2);
	
	ДанныеОбъекта.Вставить("Руководитель",          СтрШаблон("%1 %2", ИмяРук, Врег(ФамилияРук)));
	ДанныеОбъекта.Вставить("ДолжностьРуководителя", Посада);
	
	// --- Обработка Сотрудника (Дательный падеж - КОМУ) ---
	МногострочнаяСтрока = СтрЗаменить(Выборка.ДательныйПадеж, " ", Символы.ПС);
	ФамилияКому  = СтрПолучитьСтроку(МногострочнаяСтрока, 1);
	ИмяКому      = СтрПолучитьСтроку(МногострочнаяСтрока, 2);
	ОтчествоКому = СтрПолучитьСтроку(МногострочнаяСтрока, 3);
	
	ДанныеОбъекта.Вставить("СотрудникФИОКому",        СтрШаблон("%1 %2 %3", Врег(ФамилияКому), ИмяКому, ОтчествоКому));
	ДанныеОбъекта.Вставить("СотрудникИмяФамилияКому", СтрШаблон("%1 %2", ИмяКому, ФамилияКому));
	
	// --- Данные об отпуске ---
	ДанныеОбъекта.Вставить("КоличествоДнейОтпуска", Выборка.КоличествоДнейОсновногоОтпуска);
	ДанныеОбъекта.Вставить("НачалоПериода",         Формат(Выборка.ДатаНачалаОсновногоОтпуска, "ДФ='dd MMMM yyyy'"));
	ДанныеОбъекта.Вставить("КонецПериода",          Формат(Выборка.ДатаОкончанияОсновногоОтпуска, "ДФ='dd MMMM yyyy'"));
	
	РабочийПериодСтрокой = СтрШаблон("%1-%2", 
		Формат(Выборка.НачалоПериодаЗаКоторыйПредоставляетсяОтпуск, "ДФ=dd.MM.yyyy"), 
		Формат(Выборка.КонецПериодаЗаКоторыйПредоставляетсяОтпуск, "ДФ=dd.MM.yyyy"));
	ДанныеОбъекта.Вставить("РабочийПериод", РабочийПериодСтрокой);
	
	ДанныеОбъекта.Вставить("ДатаНаписанияЗаявления", Формат(Выборка.ДатаНачалаОсновногоОтпуска - 14*60*60*24, "ДФ=dd.MM.yyyy"));
	
	// --- Обработка Сотрудника (Родительный падеж - КОГО и Именительный) ---
	МногострочнаяСтрока = СтрЗаменить(Выборка.РодительныйПадеж, " ", Символы.ПС);
	ФамилияКого  = СтрПолучитьСтроку(МногострочнаяСтрока, 1);
	ИмяКого      = СтрПолучитьСтроку(МногострочнаяСтрока, 2);
	//ОтчествоКого = СтрПолучитьСтроку(МногострочнаяСтрока, 3); // В оригинале вычислялось, но не использовалось
	
	ДанныеОбъекта.Вставить("СотрудникИмяФамилияКого", СтрШаблон("%1 %2", ИмяКого, ФамилияКого));
	ДанныеОбъекта.Вставить("СотрудникФамилияИмя",     СтрШаблон("%1 %2", Выборка.Имя, Врег(Выборка.Фамилия)));
	
	Возврат ДанныеОбъекта;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция МакетыОбъектаДляПечати(Знач ИменаМакетов) 
	
	МассивИменМакетов = СтрРазделить(ИменаМакетов, ", ", Ложь);
	
	СтруктураМакеты = ПолучитьДанныеМакетов(МассивИменМакетов);
	СтруктураМакеты.Вставить("ЛокальныйКаталогФайловПечати", Неопределено);
	
	Если НЕ СтруктураМакеты.Свойство("ТипыМакетов") Тогда
		СтруктураМакеты.Макеты.Вставить("ТипыМакетов", Новый Соответствие);
	КонецЕсли;
	
	Возврат СтруктураМакеты;
	
КонецФункции

Функция ПолучитьДанныеМакетов(Знач МассивИменМакетов)
	
	ОписаниеОбластей      = Новый Соответствие;
	ДвоичныеДанныеМакетов = Новый Соответствие;
	ТипыМакетов           = Новый Соответствие;
	
	Для Каждого ИмяМакета Из МассивИменМакетов Цикл
		
		Если ИмяМакета = "МакетWORD" Тогда
			ДвоичныеДанныеМакетов.Вставить(ИмяМакета, ПолучитьМакет("МакетWORD"));
			// ВАЖНО: Добавлено указание типа макета, иначе УправлениеПечатью вернет ошибку
			ТипыМакетов.Вставить(ИмяМакета, "DOCX"); 
		КонецЕсли;
		
		ОписаниеОбластей.Вставить(ИмяМакета, ОписаниеОбластейМакетаОфисногоДокумента());
		
	КонецЦикла;
	
	Макеты = Новый Структура;
	Макеты.Вставить("ОписаниеОбластей",      ОписаниеОбластей);
	Макеты.Вставить("ДвоичныеДанныеМакетов", ДвоичныеДанныеМакетов);
	Макеты.Вставить("ТипыМакетов",           ТипыМакетов);
	
	Возврат Макеты;
	
КонецФункции

Функция ОписаниеОбластейМакетаОфисногоДокумента()
	
	ОписаниеОбластей = Новый Структура;
	
	УправлениеПечатью.ДобавитьОписаниеОбласти(ОписаниеОбластей, "Шапка", "Общая");
	УправлениеПечатью.ДобавитьОписаниеОбласти(ОписаниеОбластей, "Товары", "СтрокаТаблицы");
	УправлениеПечатью.ДобавитьОписаниеОбласти(ОписаниеОбластей, "СтрокаТаблицаТовары", "СтрокаТаблицы");
	
	Возврат ОписаниеОбластей;
	
КонецФункции

#КонецОбласти